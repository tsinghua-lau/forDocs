##  Promise æ§åˆ¶å¹¶å‘

:::tip TIP

è®¾è®¡ä¸€ä¸ªå‡½æ•°ï¼Œå¯ä»¥é™åˆ¶è¯·æ±‚çš„å¹¶å‘ï¼ŒåŒæ—¶è¯·æ±‚ç»“æŸä¹‹åï¼Œè°ƒç”¨callbackå‡½æ•°
sendRequest(requestList:,limits,callback):void

:::
```javascript

sendRequest(

[()=>request('ç¬¬ä¸€ä¸ª'),

()=>request('ç¬¬äºŒä¸ª'),

()=>request('ç¬¬ä¸‰ä¸ª'),

()=>request('ç¬¬å››ä¸ª'),

()=>request('ç¬¬äº”ä¸ª')],

2, //å¹¶å‘æ•°

(res)=>{

    console.log(res)

})

// å…¶ä¸­request å¯ä»¥æ˜¯ï¼š 
function request (url,time=1){

    return new Promise((resolve,reject)=>{

        setTimeout(()=>{


            // if(Math.random() > 0.5){

                resolve('æˆåŠŸ')
                console.log(url+'è¯·æ±‚ç»“æŸğŸ‘Œ');


            // }else{

            //     reject('é”™è¯¯;')

            // }

        },time*3000)

    })
}
```

## æ˜ç¡®æ¦‚å¿µ
âš ï¸ è¿™é‡Œæœ‰å‡ ä¸ªæ¦‚å¿µéœ€è¦æ˜ç¡®ä¸€ä¸‹

* `å¹¶å‘`ï¼šå¹¶å‘æ˜¯å¤šä¸ªä»»åŠ¡åŒæ—¶äº¤æ›¿çš„æ‰§è¡Œï¼ˆå› ä¸ºcpuæ‰§è¡ŒæŒ‡ä»¤çš„é€Ÿåº¦éå¸¸ä¹‹å¿«ï¼Œå®ƒå¯ä»¥ä¸å¿…æŒ‰é¡ºåºä¸€æ®µä»£ç ä¸€æ®µä»£ç çš„æ‰§è¡Œï¼Œè¿™æ ·æ•ˆç‡åè€Œæ›´åŠ ä½ä¸‹ï¼‰ï¼Œè¿™æ ·çœ‹èµ·æ¥å°±æ˜¯ä¸€èµ·æ‰§è¡Œçš„ï¼Œæ‰€ä»¥å«å¹¶å‘ã€‚

* `å¹¶è¡Œ`ï¼šå¯ä»¥ç†è§£ä¸ºå¤šä¸ªç‰©ç†cpuæˆ–è€…æœ‰åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œæ˜¯çœŸæ­£çš„'åŒæ—¶'æ‰§è¡Œ

* `å¹¶å‘æ§åˆ¶`ï¼šæ„æ€æ˜¯å¤šä¸ªå¹¶å‘çš„ä»»åŠ¡ï¼Œä¸€æ—¦æœ‰ä»»åŠ¡å®Œæˆï¼Œå°±ç«‹åˆ»å¼€å¯ä¸‹ä¸€ä¸ªä»»åŠ¡

* `åˆ‡ç‰‡æ§åˆ¶`ï¼šå°†å¹¶å‘ä»»åŠ¡åˆ‡ç‰‡çš„åˆ†é…å‡ºæ¥ï¼Œæ¯”å¦‚10ä¸ªä»»åŠ¡ï¼Œåˆ‡æˆ2ä¸ªç‰‡ï¼Œæ¯ç‰‡æœ‰5ä¸ªä»»åŠ¡ï¼Œå½“å‰ä¸€ç‰‡çš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œå†å¼€å§‹ä¸‹ä¸€ä¸ªç‰‡çš„ä»»åŠ¡ï¼Œè¿™æ ·æ˜æ˜¾æ•ˆç‡æ²¡å¹¶å‘æ§åˆ¶é‚£ä¹ˆé«˜äº†


## æ€è·¯

å°†å…³é”®æ­¥éª¤æ‹†åˆ†å‡ºåˆé€‚çš„å‡½æ•°æ¥ç»„ç»‡ä»£ç 

1. å¾ªç¯å»å¯åŠ¨èƒ½æ‰§è¡Œçš„ä»»åŠ¡
2. å–å‡ºä»»åŠ¡å¹¶ä¸”æ¨åˆ°æ‰§è¡Œå™¨æ‰§è¡Œ
3. æ‰§è¡Œå™¨å†…æ›´æ–°å½“å‰çš„å¹¶å‘æ•°ï¼Œå¹¶ä¸”è§¦å‘æèµ·ä»»åŠ¡
4. æèµ·ä»»åŠ¡é‡Œé¢å¯ä»¥è§¦å‘æœ€ç»ˆçš„å›è°ƒå‡½æ•°å’Œè°ƒèµ·æ‰§è¡Œå™¨ç»§ç»­æ‰§è¡Œä»»åŠ¡

## ä»£ç 

```javascript

function sendRequest(requestList,limits,callback){

    const promises = requestList.slice() // å–å¾—è¯·æ±‚listï¼ˆæµ…æ‹·è´ä¸€ä»½ï¼‰

    // å¾—åˆ°å¼€å§‹æ—¶ï¼Œèƒ½æ‰§è¡Œçš„å¹¶å‘æ•°

    const concurrentNum = Math.min(limits,requestList.length)
    console.log('ä»»åŠ¡æ‰§è¡Œå¹¶å‘æ•°ï¼š',concurrentNum,"'ä¸ª'+'ğŸ'")

    let concurrentCount = 0 // å½“å‰å¹¶å‘æ•°

    // ç¬¬ä¸€æ¬¡å…ˆè·‘èµ·å¯ä»¥å¹¶å‘çš„ä»»åŠ¡

    const runTaskNeeded = ()=>{

        let i = 0

        // å¯åŠ¨å½“å‰èƒ½æ‰§è¡Œçš„ä»»åŠ¡

        while(i<concurrentNum){

            i++

            runTask()

        }

    }

    // å–å‡ºä»»åŠ¡å¹¶ä¸”æ‰§è¡Œä»»åŠ¡

    const runTask = ()=>{

        const task = promises.shift()

        task && runner(task)

    }




    // æ‰§è¡Œå™¨

    // æ‰§è¡Œä»»åŠ¡ï¼ŒåŒæ—¶æ›´æ–°å½“å‰å¹¶å‘æ•°

    const runner = async (task)=>{

        try {

            concurrentCount++
            console.log('å½“å‰task',task)
            console.log('ä»»åŠ¡å¼€å§‹æ‰§è¡Œ==> concurrentCount++')

            await task()

        } catch (error) {
            console.error(error)
        }finally{

            // å¹¶å‘æ•°--

            concurrentCount--
            console.log('ç»“æŸæ‰§è¡Œæ‰§è¡Œ ==>concurrentCount--')

            
            // æèµ·ä¸‹ä¸€ä¸ªä»»åŠ¡
            picker()

        }

    }

// æèµ·ä¸‹ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œ

    const picker = ()=>{
        
        console.log('æèµ·ä¸‹ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œ')

        // ä»»åŠ¡é˜Ÿåˆ—é‡Œè¿˜æœ‰ä»»åŠ¡å¹¶ä¸”æ­¤æ—¶è¿˜æœ‰å‰©ä½™å¹¶å‘æ•°çš„æ—¶å€™ æ‰§è¡Œ
        if(concurrentCount < limits && promises.length > 0 ){

            runTask()

        // é˜Ÿåˆ—ä¸ºç©ºçš„æ—¶å€™ï¼Œå¹¶ä¸”è¯·æ±‚æ± æ¸…ç©ºäº†ï¼Œå°±å¯ä»¥æ‰§è¡Œæœ€åçš„å›è°ƒå‡½æ•°äº†

        }else if(promises.length ==0 && concurrentCount ==0 ){

            console.log('å…¨éƒ¨æ‰§è¡Œç»“æŸğŸ’«')
            callback && callback()

        }

    }



    // å…¥å£æ‰§è¡Œ

    runTaskNeeded()

}


```

![promise](/images/web/promise.gif)